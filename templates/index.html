<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>R√°dio IAE News</title>
  <style>
    :root {
      --bg: #0f0f12;
      --card: #1a1a1f;
      --accent: #6366f1;
      --accent-hover: #818cf8;
      --stop: #dc2626;
      --stop-hover: #ef4444;
      --text: #e4e4e7;
      --text-muted: #71717a;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      min-height: 100vh;
      padding: 1rem;
      display: flex;
      flex-direction: column;
    }
    .container { max-width: 560px; margin: 0 auto; width: 100%; flex: 1; }
    h1 { font-size: 1.75rem; font-weight: 600; margin-bottom: 0.25rem; }
    .sub { color: var(--text-muted); font-size: 0.95rem; margin-bottom: 1rem; }
    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 1.25rem 1.5rem;
      margin-bottom: 1rem;
    }
    .card h2 {
      font-size: 1rem;
      font-weight: 600;
      margin: 0 0 0.75rem 0;
      color: var(--text-muted);
    }
    .now-playing { font-size: 1rem; font-weight: 500; margin-bottom: 0.5rem; min-height: 1.2em; }
    .now-playing.news { color: #86efac; }
    .now-playing.music { color: #93c5fd; }
    .track-scroll {
      overflow: hidden;
      white-space: nowrap;
      margin-bottom: 0.75rem;
      padding: 0.25rem 0;
      font-size: 0.95rem;
      color: var(--text-muted);
    }
    .track-scroll span {
      display: inline-block;
      padding-left: 100%;
      animation: scroll 15s linear infinite;
    }
    @keyframes scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }
    .btn-row { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem; }
    .btn-play {
      background: var(--accent);
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      font-size: 0.95rem;
      cursor: pointer;
      font-weight: 600;
    }
    .btn-play:hover { background: var(--accent-hover); }
    .btn-play:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-stop {
      background: var(--stop);
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      font-size: 0.95rem;
      cursor: pointer;
      font-weight: 600;
    }
    .btn-stop:hover { background: var(--stop-hover); }
    .btn-stop:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-skip, .btn-music-only {
      background: var(--card);
      border: 1px solid var(--text-muted);
      color: var(--text);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .btn-music-only.active { border-color: var(--accent); color: var(--accent); }
    .status { font-size: 0.85rem; margin-top: 0.5rem; color: var(--text-muted); }
    audio { width: 100%; margin-top: 0.5rem; height: 36px; }

    .chat-section { margin-top: auto; }
    .chat-box {
      background: var(--card);
      border-radius: 12px;
      padding: 1rem;
      max-height: 220px;
      display: flex;
      flex-direction: column;
    }
    .chat-box h3 { font-size: 0.95rem; color: var(--text-muted); margin: 0 0 0.5rem 0; }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      min-height: 80px;
    }
    .chat-messages p { margin: 0.35rem 0; }
    .chat-messages .user { color: #93c5fd; }
    .chat-messages .ai { color: #86efac; }
    .chat-form { display: flex; gap: 0.5rem; }
    .chat-form input {
      flex: 1;
      background: var(--bg);
      border: 1px solid var(--text-muted);
      border-radius: 8px;
      padding: 0.5rem 0.75rem;
      color: var(--text);
      font-size: 0.9rem;
    }
    .chat-form button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .chat-form button[type="button"] {
      background: transparent;
      border: 1px solid var(--text-muted);
      color: var(--text-muted);
    }
    .chat-form button[type="button"]:hover { color: var(--accent); border-color: var(--accent); }
  </style>
</head>
<body>
  <div class="container">
    <h1>R√°dio IAE News</h1>
    <p class="sub">Play: not√≠cia ‚Üí m√∫sica ‚Üí m√∫sica ‚Üí not√≠cia. Ou s√≥ m√∫sicas.</p>

    <div class="card">
      <h2>Programa√ß√£o</h2>
      <p id="now-playing" class="now-playing"></p>
      <div class="track-scroll" id="track-scroll">
        <span id="track-title"></span>
      </div>
      <div class="btn-row">
        <button id="btn-play" class="btn-play" type="button">‚ñ∂ Play</button>
        <button id="btn-stop" class="btn-stop" type="button">‚ñ† Parar</button>
        <button id="btn-skip" class="btn-skip" type="button" title="Pr√≥ximo">‚è≠ Avan√ßar</button>
        <button id="btn-music-only" class="btn-music-only" type="button">üéµ S√≥ m√∫sicas</button>
      </div>
      <p id="status" class="status"></p>
      <audio id="player" preload="auto"></audio>
    </div>

    <div class="chat-section">
      <div class="chat-box">
        <h3>Chat ‚Äì conversa entre ouvintes (todos na r√°dio veem). Respeite os outros.</h3>
        <div class="chat-messages" id="chat-messages"></div>
        <form class="chat-form" id="chat-form">
          <input type="text" id="chat-input" placeholder="Digite sua mensagem..." autocomplete="off" maxlength="300" />
          <button type="submit">Enviar</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    const btnPlay = document.getElementById('btn-play');
    const btnStop = document.getElementById('btn-stop');
    const btnSkip = document.getElementById('btn-skip');
    const btnMusicOnly = document.getElementById('btn-music-only');
    const player = document.getElementById('player');
    const nowPlaying = document.getElementById('now-playing');
    const statusEl = document.getElementById('status');
    const trackTitle = document.getElementById('track-title');
    const trackScroll = document.getElementById('track-scroll');
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');

    let playing = false;
    let musicOnly = false;
    let isSkipping = false;

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    function setNow(type, label) {
      nowPlaying.textContent = label;
      nowPlaying.className = 'now-playing ' + (type === 'news' ? 'news' : 'music');
    }

    function setTrackTitle(title) {
      trackTitle.textContent = title || '';
      trackScroll.style.display = title ? 'block' : 'none';
    }

    async function checkCanPlay() {
      const res = await fetch('/api/status');
      const data = await res.json();
      return data.canPlay;
    }

    async function waitForReady() {
      setStatus('Preparando blocos‚Ä¶ (pode levar ~1 min)');
      while (playing) {
        const res = await fetch('/api/status');
        const data = await res.json();
        if (data.canPlay) {
          setStatus(data.blocksReady + ' bloco(s) pronto(s). Iniciando‚Ä¶');
          return true;
        }
        await new Promise(r => setTimeout(r, 3000));
      }
      return false;
    }

    function apiNextUrl() {
      return musicOnly ? '/api/next?mode=music_only' : '/api/next';
    }

    async function playNext() {
      if (!playing) return;
      const res = await fetch(apiNextUrl());
      if (res.status === 503) {
        const data = await res.json();
        setStatus(data.message || 'Aguardando‚Ä¶');
        player.src = '';
        setTimeout(playNext, 4000);
        return;
      }
      const data = await res.json();
      if (!data.ready || !data.url) {
        setStatus('Fim ou erro.');
        playing = false;
        btnPlay.disabled = false;
        btnStop.disabled = true;
        return;
      }
      setNow(data.type, data.type === 'news' ? 'üìª Not√≠cias' : 'üéµ M√∫sica');
      setTrackTitle(data.title || '');
      setStatus('');
      player.volume = data.type === 'music' ? 0.82 : 1.0;
      player.src = data.url;
      player.play().catch(() => {
        if (playing) setTimeout(playNext, 2000);
      });
      setTimeout(function() { isSkipping = false; }, 200);
    }

    player.addEventListener('ended', () => {
      if (!playing || isSkipping) return;
      setTimeout(playNext, 400);
    });

    player.addEventListener('error', () => {
      if (!playing) return;
      setStatus('Erro ao carregar. Pr√≥ximo em 3s‚Ä¶');
      setTimeout(playNext, 3000);
    });

    btnPlay.addEventListener('click', async () => {
      playing = true;
      btnPlay.disabled = true;
      btnStop.disabled = false;
      if (!musicOnly) {
        const ok = await waitForReady();
        if (!ok) {
          playing = false;
          btnPlay.disabled = false;
          btnStop.disabled = true;
          return;
        }
      }
      playNext();
    });

    btnStop.addEventListener('click', () => {
      playing = false;
      player.pause();
      player.src = '';
      nowPlaying.textContent = '';
      nowPlaying.className = 'now-playing';
      setTrackTitle('');
      setStatus('Parado.');
      btnPlay.disabled = false;
      btnStop.disabled = true;
    });

    btnSkip.addEventListener('click', () => {
      if (!playing) return;
      isSkipping = true;
      player.pause();
      player.src = '';
      playNext();
    });

    btnMusicOnly.addEventListener('click', () => {
      musicOnly = !musicOnly;
      btnMusicOnly.classList.toggle('active', musicOnly);
      if (musicOnly) setStatus('Modo s√≥ m√∫sicas. Aperte Play.');
      else setStatus('');
    });

    async function refreshChat() {
      try {
        const res = await fetch('/api/chat/messages');
        const data = await res.json();
        const list = data.messages || [];
        chatMessages.innerHTML = list.map(m => {
          const who = m.user || '?';
          const cls = m.kind === 'ai' ? 'ai' : 'user';
          return '<p class="' + cls + '">' + who + ': ' + (m.text || '').replace(/</g, '&lt;') + '</p>';
        }).join('');
        chatMessages.scrollTop = chatMessages.scrollHeight;
      } catch (_) {}
    }

    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const msg = chatInput.value.trim();
      if (!msg) return;
      chatInput.disabled = true;
      try {
        const res = await fetch('/api/chat/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: msg }),
        });
        const data = await res.json();
        if (data.ok) {
          chatInput.value = '';
          refreshChat();
        } else {
          statusEl.textContent = data.error || 'Erro ao enviar.';
        }
      } catch (_) {
        statusEl.textContent = 'Erro ao enviar.';
      }
      chatInput.disabled = false;
    });

    setInterval(refreshChat, 3000);
    refreshChat();

    (async function init() {
      setStatus('Carregando‚Ä¶');
      const canPlay = await checkCanPlay();
      if (canPlay) setStatus('Pronto. Aperte Play.');
      else setStatus('Preparando primeiro bloco. Aperte Play em ~1 min.');
    })();
  </script>
</body>
</html>
